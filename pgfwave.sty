% Copyright (c) 2009 Martin Scharrer <martin@scharrer-online.de>
% This file is under the LPPL v1.3c (or later) licence.

\ProvidesPackage{pgfwave}[2009/04/06 v0.1a Draw Digital Wave Diagrams]
\RequirePackage{tikz}

\def\dwprefix{path@}

\def\textwave#1{%
  \begingroup
    \def\lastchar{}%
    \setcounter{pgfwavechars}{0}%
    \let\currentchar\empty
    \let\str\empty
    \textwaveX#1\relax
    %\message{^^J\meaning\str}%
    \begin{tikzpicture}[x=1.75ex,y=1.75ex,thick]
      %\draw[step=50,very thin,color=gray] (0,0) grid (50*\value{pgfwavechars},100);
      \draw (0,0) \str;%
    \end{tikzpicture}
    \ifnum\c@maxpgfwavechars<\c@pgfwavechars
      \global\c@maxpgfwavechars=\c@pgfwavechars
    \fi
  \endgroup
}

\def\wave{
  \@ifnextchar{[}%
    {\wave@}%
    {\wave@[]}%
}

\def\wave@[#1]{%
  \@ifnextchar{+}%
    {\wave@@{#1}}%
    {\@ifnextchar{(}%
      {\wave@@{#1}}%
      {\wave@@{#1}(0,0)}%
    }%
}

\def\wave@@#1#2(#3){%
  \wave@@@{#1}{#2(#3)}%
}

\def\wave@@@#1#2#3{%
  \begingroup
    \def\lastchar{}%
    \setcounter{pgfwavechars}{0}%
    \let\currentchar\empty
    \let\str\empty
    \textwaveX#3\relax
    \draw [x=1.75ex,y=1.75ex,thick,#1] #2 \str;%
    \ifnum\c@maxpgfwavechars<\c@pgfwavechars
      \global\c@maxpgfwavechars=\c@pgfwavechars
    \fi
  \endgroup
  \@ifnextchar{;}{\@gobble}{}%
}

\newcounter{pgfwavechars}
\newcounter{maxpgfwavechars}

\def\textwaveX#1{%
  \ifx\relax#1\empty
  \else
    \pgfwave@iflower{#1}%
      {\addtocounter{pgfwavechars}{+1}}%
      {\addtocounter{pgfwavechars}{+2}}%
    \def\currentchar{#1}%
    \edef\str{\str\csname \dwprefix\lastchar\currentchar\endcsname}%
    \let\lastchar\currentchar
    \expandafter
    \textwaveX
  \fi
}

\def\sigH{H}
\def\sigL{L}

\def\slope{\csname waveslope\endcsname}%
\def\zslope{\csname wavezslope\endcsname}%
\def\dslope{\csname wavedslope\endcsname}%

\makeatletter

\def\pgfwave@iflower#1{%
  \begingroup
  \edef\@tempa{`#1}%
  \ifnum\@tempa=\lccode\@tempa
    \endgroup
    \expandafter
    \@firstoftwo
  \else
    \endgroup
    \expandafter
    \@secondoftwo
  \fi
}


\def\pgfwavesetslope#1{%
  \edef\waveslope{#1/100.0*\width}%
  \edef\wavezslope{#1/200.0*\width}%
  \edef\wavedslope{#1/25.0*\width}%
}
\AtBeginDocument{%
  \pgfwavesetslope{10}%
}

\providecommand*\@nameedef[1]{%
  \expandafter\edef
  \csname #1\endcsname
}

\def\pgfwavedef#1{%
  \pgfwavedef@#1\relax%
}

\def\pgfwavedef@#1#2\relax#3{%
  \ifx\relax#2\relax
    \pgfwave@iflower{#1}%
      {\def\width{\csname wavewidth\endcsname/2.}}%
      {\def\width{\csname wavewidth\endcsname}}%
    \expandafter\edef\csname \dwprefix#1\endcsname{#3}%
  \else
    \pgfwave@iflower{#2}%
      {\def\width{\csname wavewidth\endcsname/2.}}%
      {\def\width{\csname wavewidth\endcsname}}%
    \expandafter\edef\csname \dwprefix#1#2\endcsname{#3}%
    \pgfwave@iflower{#2}{}%
      {\pgfwave@iflower{#1}{}%
        {%
          \uppercase{\lowercase{\pgfwavedef@{#1}}{#2}}\relax{#3}%
          \lowercase{\uppercase{\pgfwavedef@{#1}}{#2}}\relax{#3}%
          \lowercase{\pgfwavedef@{#1}{#2}}\relax{#3}%
        }%
      }%
  \fi
}

\def\pgfwavelet#1#2{%
  \pgfwavelet@#1\relax#2\relax
}

\def\pgfwavelet@#1#2\relax#3#4\relax{%
  \expandafter
  \let\csname \dwprefix#1#2\expandafter\endcsname\csname \dwprefix#3#4\endcsname
  \pgfwave@iflower{#1}{}%
    {\pgfwave@iflower{#2}{}%
      {%
        \uppercase{\lowercase{%
        \uppercase{\lowercase{\pgfwavelet@{#1}}{#2}}\relax{#3}}{#4}}\relax%
        \lowercase{\uppercase{%
        \lowercase{\uppercase{\pgfwavelet@{#1}}{#2}}\relax{#3}}{#4}}\relax%
        \lowercase{\pgfwavelet@{#1}{#2}\relax{#3}{#4}}\relax%
      }%
    }%
}
\AtBeginDocument{%
  \def\wavewidth{1}%
  \def\waveheight{1}%
}
\def\width{\csname wavewidth\endcsname}
\def\fwidth{\csname wavewidth\endcsname}
\def\width{\csname wavewidth\endcsname}
\def\height{\csname waveheight\endcsname}

\def\pgfwave@chars#1{}
\def\pgfwave@char@nums#1{}

\def\pgfwavechar#1{%
  \uppercase{%
  \edef\pgfwave@chars{\pgfwave@chars,#1}%
  \pgfwavechar@{#1}}%
}

\def\pgfwavechar@#1#2#3{%
  \def\width{\csname wavewidth\endcsname}%
  \@nameedef{\dwprefix#1}{#2#3}%
  \def\width{\csname wavewidth\endcsname/2.}%
  \lowercase{\@nameedef{\dwprefix#1}}{#2#3}%
  \pgfwavedef{#1#1}{#3}%
}

\def\pgfwavealias#1#2{%
  \uppercase{\pgfwavealias@{#1}{#2}}%
}

\def\pgfwavealias@#1#2{%
  \expandafter
  \let\csname \dwprefix#1\expandafter\endcsname
  \csname \dwprefix#2\endcsname
  \lowercase{%
  \expandafter
  \let\csname \dwprefix#1\expandafter\endcsname
  \csname \dwprefix#2\endcsname
  }%
  \uppercase{\pgfwavelet{#1#1}{#2#2}}%
  \uppercase{%
    \@for\@tempa:=\pgfwave@chars\do{%
      \expandafter\pgfwavelet@@
      \expandafter{\@tempa}{#1}{#2}%
    }%
  }%
}

\def\pgfwavelet@@#1#2#3{%
  \pgfwavelet{#1#2}{#1#3}%
  \pgfwavelet{#2#1}{#3#1}%
}

\pgfwavechar{H}{++(0,\height)}{-- ++(\width,0) }
\pgfwavechar{L}{++(0,0)}{-- ++(\width,0) }
\pgfwavechar{Z}{++(0,\height/2.)}{-- ++(\width,0) }
\pgfwavechar{D}{++(0,0)}{-- ++(+\width,0) ++(-\width*1.1,+\height)
                -- ++(+\width*1.1,0) ++(0,-\height) }

\pgfwavedef{HH}{-- ++(\width,0) }
\pgfwavedef{LL}{-- ++(\width,0) }
\pgfwavedef{HL}{-- ++(\slope,-\height) -- ++(\width-\slope,0) }
\pgfwavedef{LH}{-- ++(\slope, \height) -- ++(\width-\slope,0) }

\pgfwavedef{ZZ}{-- ++(\width,0) }
\pgfwavedef{LZ}{-- ++(\zslope,+\height/2.) -- ++(\width-\zslope,0) }
\pgfwavedef{HZ}{-- ++(\zslope,-\height/2.) -- ++(\width-\zslope,0) }
\pgfwavedef{ZH}{-- ++(\zslope,+\height/2.) -- ++(\width-\zslope,0) }
\pgfwavedef{ZL}{-- ++(\zslope,-\height/2.) -- ++(\width-\zslope,0) }

\pgfwavedef{DZ}{}
\pgfwavedef{ZD}{
            -- ++(\dslope/2.,\height/2.)   -- ++(\width-\dslope/2.,0)
               ++(-\width,-\height/2.)
            -- ++(\dslope/2.,-\height/2.)  -- ++(\width-\dslope/2.,0) }
\pgfwavedef{DZ}{
               ++(-\width/10.,0)        -- ++(+\width/10.,0)
            -- ++( \dslope/2.,+\height/2.)
               ++(-\dslope/2.,+\height/2.)
               ++(-\width/10.,0)        -- ++(+\width/10.,0)
            -- ++( \dslope/2.,-\height/2.) -- ++(\width-\dslope/2.,0) }

\pgfwavedef{LD}{
            -- ++(\dslope,\height)       -- ++(\width-\dslope,0)
               ++(-\width,-\height)        ++(\dslope/2.,+\height/2.)
            -- ++(\dslope/2.,-\height/2.)  -- ++(\width-\dslope,0) }
\pgfwavedef{DL}{
               ++(-\width/10.,0)        -- ++(+\width/10.,0)
            -- ++( \dslope/2.,+\height/2.)
               ++(-\dslope/2.,+\height/2.)
               ++(-\width/10.,0)        -- ++(+\width/10.,0)
            -- ++(\dslope,-\height)      -- ++(\width-\dslope,0) }
\pgfwavedef{HD}{-- ++(\dslope,-\height)
            -- ++(\width-\dslope,0)
               ++(-\width,+\height) ++(\dslope/2.,-\height/2.)
            -- ++(\dslope/2.,+\height/2.) -- ++(\width-\dslope,0)
               ++(0,-\height) }
\pgfwavedef{DH}{   ++(0,+\height)
               ++(-\width/10.,0) -- ++(+\width/10.,0)
            -- ++(\dslope/2.,-\height/2.)
               ++(-\dslope/2.,-\height/2.)
               ++(-\width/10.,0) -- ++(+\width/10.,0)
            -- ++(\dslope,+\height) -- ++(\width-\dslope,0) }
\pgfwavedef{DD}{-- ++(+\width,0) ++(-\width*1.1,+\height) 
%++(-\width/2.,+\height/2.) node [scale=0.75] {A} ++(-\width/2.+1,+\height/2.)
            -- ++(+\width*1.1,0) ++(0,-\height) }

\pgfwavealias{X}{D}
\pgfwavedef{XX}{
               ++(-\width/10.,0) -- ++(+\width/10.,0)
            -- ++(\dslope,+\height) -- ++(\width-\dslope,0)
               ++(-\width,0)
               ++(-\width/10.,0) -- ++(+\width/10.,0)
            -- ++(\dslope,-\height) -- ++(\width-\dslope,0) }
\pgfwavelet{DX}{XX}

\pgfwavealias{M}{Z}
\pgfwavechar{M}{++(0,\height/2.)}{
  -- ++(\width/16.,+\height*.225)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/8.,+\height*.45)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/8.,+\height*.45)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/8.,+\height*.45)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/16.,+\height*.225)
}

\pgfwavedef{m}{
     ++(0,+\height/2.)
  -- ++(\width/8.,+\height*.225)
  -- ++(\width/4.,-\height*.45)
  -- ++(\width/4.,+\height*.45)
  -- ++(\width/4.,-\height*.45)
  -- ++(\width/8.,+\height*.225)
}

\pgfwavedef{ZM}{
  -- ++(\width/16.,+\height*.075)
  -- ++(\width/8.,-\height*.20)
  -- ++(\width/8.,+\height*.25)
  -- ++(\width/8.,-\height*.30)
  -- ++(\width/8.,+\height*.35)
  -- ++(\width/8.,-\height*.40)
  -- ++(\width/8.,+\height*.45)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/16.,+\height*.225)
}

\pgfwavedef{Zm}{
  -- ++(\width/8.,+\height*.075)
  -- ++(\width/4.,-\height*.20)
  -- ++(\width/4.,+\height*.25)
  -- ++(\width/4.,-\height*.30)
  -- ++(\width/8.,+\height*.175)
}
\pgfwavelet{zm}{Zm}

\pgfwavedef{Mm}{
  -- ++(\width/8.,+\height*.225)
  -- ++(\width/4.,-\height*.45)
  -- ++(\width/4.,+\height*.45)
  -- ++(\width/4.,-\height*.45)
  -- ++(\width/8.,+\height*.225)
}
\pgfwavelet{mm}{Mm}

\pgfwavedef{LM}{
  -- ++(\width/16.,+\height*.60)
  -- ++(\width/8.,-\height*.20)
  -- ++(\width/8.,+\height*.25)
  -- ++(\width/8.,-\height*.30)
  -- ++(\width/8.,+\height*.35)
  -- ++(\width/8.,-\height*.40)
  -- ++(\width/8.,+\height*.45)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/16.,+\height*.20)
}
\pgfwavedef{HM}{
  -- ++(\width/16.,-\height*.40)
  -- ++(\width/8.,-\height*.20)
  -- ++(\width/8.,+\height*.25)
  -- ++(\width/8.,-\height*.30)
  -- ++(\width/8.,+\height*.35)
  -- ++(\width/8.,-\height*.40)
  -- ++(\width/8.,+\height*.45)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/16.,+\height*.20)
}
\pgfwavedef{DM}{
     ++(-\width/16,0)
  -- ++(+\width/16,0)
  -- ++(\width/16.,+\height*.50)
     ++(-\width/8,+\height*.50)
  -- ++(+\width/16,0)
  -- ++(\width/16.,-\height*.50)
  -- ++(\width/8.,-\height*.10)
  -- ++(\width/8.,+\height*.25)
  -- ++(\width/8.,-\height*.30)
  -- ++(\width/8.,+\height*.35)
  -- ++(\width/8.,-\height*.40)
  -- ++(\width/8.,+\height*.45)
  -- ++(\width/8.,-\height*.45)
  -- ++(\width/16.,+\height*.20)
}
\pgfwavelet{XM}{DM}
\pgfwavelet{MX}{MD}

\pgfwavedef{Lm}{
  -- ++(\width/8.,+\height*.575)
  -- ++(\width/4.,-\height*.20)
  -- ++(\width/4.,+\height*.25)
  -- ++(\width/4.,-\height*.30)
  -- ++(\width/8.,+\height*.175)
}
\pgfwavedef{Hm}{
  -- ++(\width/8.,-\height*.425)
  -- ++(\width/4.,-\height*.20)
  -- ++(\width/4.,+\height*.25)
  -- ++(\width/4.,-\height*.30)
  -- ++(\width/8.,+\height*.175)
}
\pgfwavedef{Dm}{
     ++(-\width/8,0)
  -- ++(+\width/8,0)
  -- ++(\width/8.,+\height*.50)
     ++(-\width/4,+\height*.50)
  -- ++(+\width/8,0)
  -- ++(\width/8.,-\height*.50)
  -- ++(\width/4.,-\height*.10)
  -- ++(\width/4.,+\height*.25)
  -- ++(\width/4.,-\height*.30)
  -- ++(\width/8.,+\height*.15)
}
\pgfwavelet{lm}{Lm}
\pgfwavelet{hm}{Hm}
\pgfwavelet{dm}{Dm}
\pgfwavelet{Xm}{Dm}
\pgfwavelet{mX}{mD}
\pgfwavelet{xm}{dm}



